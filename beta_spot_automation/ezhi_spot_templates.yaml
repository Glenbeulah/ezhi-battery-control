# ============================================================================
# EZHI Spot-Steuerung v1.1.0-beta - Template Sensoren
# ============================================================================
# Einbinden in configuration.yaml:
#
#   template: !include ezhi_spot_templates.yaml
#
# BENÖTIGT:
# - ezhi_spot_sql.yaml für Verbrauchsprofil
# - EPEX Spot Integration (HACS)
# - Solcast Integration (HACS)
#
# OPTIONAL:
# - Hausverbrauch-Sensor (siehe unten) für genaues Verbrauchsprofil
# ============================================================================

- sensor:
    # =================================================================
    # HAUSVERBRAUCH TOTAL (OPTIONAL - für genaues Verbrauchsprofil)
    # =================================================================
    # Aktiviere diesen Sensor für ein genaues Verbrauchsprofil inkl.
    # PV-Eigenverbrauch. Ohne diesen Sensor zeigt das Profil nur Netzbezug.
    #
    # ANPASSEN: Ersetze die Sensor-Namen mit deinen eigenen!
    # Wenn du keinen Hausverbrauch-Sensor brauchst, lösche diesen Block.
    #
    # Formel: Netzbezug + PV + Batterie_Out - Einspeisung - Batterie_In
    # =================================================================
    # - name: "Hausverbrauch Total"
    #   unique_id: hausverbrauch_total_wh
    #   unit_of_measurement: "Wh"
    #   device_class: energy
    #   state_class: total_increasing
    #   icon: mdi:home-lightning-bolt
    #   state: >
    #     {% set netzbezug = states('sensor.DEIN_SMARTMETER_IMPORT_WH') | float(0) %}
    #     {% set einspeisung = states('sensor.DEIN_SMARTMETER_EXPORT_WH') | float(0) %}
    #     {% set pv_total = states('sensor.DEIN_PV_LIFETIME_ENERGY_WH') | float(0) %}
    #     {% set batterie_out = states('sensor.DEIN_BATTERIE_DISCHARGE_WH') | float(0) %}
    #     {% set batterie_in = states('sensor.DEIN_BATTERIE_CHARGE_WH') | float(0) %}
    #     {{ (netzbezug + pv_total + batterie_out - einspeisung - batterie_in) | round(1) }}

    # =================================================================
    # VERBRAUCHSPROGNOSE aus SQL-Sensor
    # =================================================================
    - name: "EZHI Erwarteter Verbrauch Stunde"
      unique_id: ezhi_expected_consumption_hour
      unit_of_measurement: "Wh"
      icon: mdi:home-lightning-bolt
      state: >
        {% set data = state_attr('sensor.ezhi_verbrauchsprofil_7_tage', 'hourly_json') %}
        {% if data %}
          {% set json = data | from_json %}
          {% set hour = now().strftime('%H') %}
          {{ json.get(hour, 300) | int }}
        {% else %}
          300
        {% endif %}
      attributes:
        naechste_stunde: >
          {% set data = state_attr('sensor.ezhi_verbrauchsprofil_7_tage', 'hourly_json') %}
          {% if data %}
            {% set json = data | from_json %}
            {% set hour = '%02d' % ((now().hour + 1) % 24) %}
            {{ json.get(hour, 300) | int }}
          {% else %}
            300
          {% endif %}
        naechste_4_stunden: >
          {% set data = state_attr('sensor.ezhi_verbrauchsprofil_7_tage', 'hourly_json') %}
          {% if data %}
            {% set json = data | from_json %}
            {% set ns = namespace(total=0) %}
            {% for i in range(1, 5) %}
              {% set hour = '%02d' % ((now().hour + i) % 24) %}
              {% set ns.total = ns.total + (json.get(hour, 300) | int) %}
            {% endfor %}
            {{ ns.total }}
          {% else %}
            1200
          {% endif %}
        profil_json: "{{ state_attr('sensor.ezhi_verbrauchsprofil_7_tage', 'hourly_json') }}"

    # =================================================================
    # PV PROGNOSE NÄCHSTE 4 STUNDEN (aus Solcast detailedHourly)
    # =================================================================
    - name: "EZHI PV Prognose 4h"
      unique_id: ezhi_pv_forecast_4h
      unit_of_measurement: "Wh"
      icon: mdi:solar-power
      state: >
        {% set forecasts = state_attr('sensor.solcast_pv_forecast_prognose_heute', 'detailedHourly') %}
        {% if forecasts %}
          {% set now_hour = now().hour %}
          {% set today = now().strftime('%Y-%m-%d') %}
          {% set ns = namespace(total=0) %}
          {% for i in range(1, 5) %}
            {% set target_hour = (now_hour + i) % 24 %}
            {% set target_str = '%sT%02d:00:00' % (today, target_hour) %}
            {% for fc in forecasts %}
              {% if target_str in fc.period_start %}
                {% set ns.total = ns.total + (fc.pv_estimate | float(0) * 1000) %}
              {% endif %}
            {% endfor %}
          {% endfor %}
          {{ ns.total | round(0) }}
        {% else %}
          0
        {% endif %}
      attributes:
        details: >
          {% set forecasts = state_attr('sensor.solcast_pv_forecast_prognose_heute', 'detailedHourly') %}
          {% if forecasts %}
            {% set now_hour = now().hour %}
            {% set today = now().strftime('%Y-%m-%d') %}
            {% set ns = namespace(hours=[]) %}
            {% for i in range(1, 5) %}
              {% set target_hour = (now_hour + i) % 24 %}
              {% set target_str = '%sT%02d:00:00' % (today, target_hour) %}
              {% for fc in forecasts %}
                {% if target_str in fc.period_start %}
                  {% set ns.hours = ns.hours + [{'hour': target_hour, 'wh': (fc.pv_estimate | float(0) * 1000) | round(0)}] %}
                {% endif %}
              {% endfor %}
            {% endfor %}
            {{ ns.hours }}
          {% else %}
            []
          {% endif %}

    # =================================================================
    # ENERGIE-BILANZ: PV vs. Verbrauch für nächste 4 Stunden
    # =================================================================
    - name: "EZHI Energie Bilanz 4h"
      unique_id: ezhi_energy_balance_4h
      unit_of_measurement: "Wh"
      icon: mdi:scale-balance
      state: >
        {% set pv_4h = states('sensor.ezhi_pv_prognose_4h') | int(0) %}
        {% set verbrauch_4h = state_attr('sensor.ezhi_erwarteter_verbrauch_stunde', 'naechste_4_stunden') | int(1200) %}
        {{ (pv_4h - verbrauch_4h) | round(0) }}
      attributes:
        pv_erwartet_wh: "{{ states('sensor.ezhi_pv_prognose_4h') | int(0) }}"
        verbrauch_erwartet_wh: "{{ state_attr('sensor.ezhi_erwarteter_verbrauch_stunde', 'naechste_4_stunden') | int(1200) }}"
        bewertung: >
          {% set bilanz = states('sensor.ezhi_energie_bilanz_4h') | int(0) %}
          {% if bilanz > 2000 %}
            Überschuss
          {% elif bilanz > 0 %}
            Ausgeglichen
          {% elif bilanz > -1000 %}
            Leichtes Defizit
          {% else %}
            Defizit
          {% endif %}

    # =================================================================
    # SPOT-BEWERTUNG: Kombiniert Preis + PV + Verbrauch
    # =================================================================
    - name: "EZHI Spot Empfehlung"
      unique_id: ezhi_spot_recommendation
      icon: >
        {% set action = states('sensor.ezhi_spot_action') %}
        {% if action == 'laden' %}
          mdi:battery-charging
        {% elif action == 'entladen' %}
          mdi:battery-arrow-down
        {% elif action == 'halten' %}
          mdi:battery-lock
        {% else %}
          mdi:battery
        {% endif %}
      state: "{{ states('sensor.ezhi_spot_action') }}"
      attributes:
        spot_preis: "{{ states('sensor.epex_spot_data_market_price') | float(0) }}"
        spot_rank: "{{ states('sensor.epex_spot_data_rank') | int(12) }}"
        spot_quantile: "{{ states('sensor.epex_spot_data_quantile') | float(0.5) }}"
        pv_4h_wh: "{{ states('sensor.ezhi_pv_prognose_4h') | int(0) }}"
        pv_rest_heute_kwh: "{{ states('sensor.solcast_pv_forecast_prognose_verbleibende_leistung_heute') | float(0) }}"
        pv_morgen_kwh: "{{ states('sensor.solcast_pv_forecast_prognose_morgen') | float(0) }}"
        verbrauch_stunde_wh: "{{ states('sensor.ezhi_erwarteter_verbrauch_stunde') | int(300) }}"
        verbrauch_4h_wh: "{{ state_attr('sensor.ezhi_erwarteter_verbrauch_stunde', 'naechste_4_stunden') | int(1200) }}"
        energie_bilanz_wh: "{{ states('sensor.ezhi_energie_bilanz_4h') | int(0) }}"
        grund: "{{ states('sensor.ezhi_spot_grund') }}"

    # =================================================================
    # SPOT-AKTION: Was soll die Batterie tun?
    # =================================================================
    - name: "EZHI Spot Action"
      unique_id: ezhi_spot_action
      state: >
        {% set rank = states('sensor.epex_spot_data_rank') | int(12) %}
        {% set quantile = states('sensor.epex_spot_data_quantile') | float(0.5) %}
        {% set pv_4h = states('sensor.ezhi_pv_prognose_4h') | int(0) %}
        {% set pv_morgen = states('sensor.solcast_pv_forecast_prognose_morgen') | float(0) %}
        {% set hour = now().hour %}
        {% set bilanz = states('sensor.ezhi_energie_bilanz_4h') | int(0) %}
        {% set verbrauch_4h = state_attr('sensor.ezhi_erwarteter_verbrauch_stunde', 'naechste_4_stunden') | int(1200) %}
        
        {# === BILLIGSTE STUNDEN (Rang 1-4 oder Quantil < 0.2) === #}
        {% if rank <= 4 or quantile < 0.2 %}
          {# Nicht laden wenn genug PV in den nächsten 4h kommt #}
          {% if bilanz > 2000 %}
            normal
          {% else %}
            laden
          {% endif %}
        
        {# === TEUERSTE STUNDEN (Rang 21-24 oder Quantil > 0.8) === #}
        {% elif rank >= 21 or quantile > 0.8 %}
          entladen
        
        {# === MITTLERER BEREICH === #}
        {% else %}
          {# Viel PV in nächsten 4h erwartet: Batterie schonen #}
          {% if bilanz > 1000 %}
            halten
          {# Abends mit guter Prognose morgen: Batterie schonen #}
          {% elif hour >= 18 and pv_morgen > 5 %}
            halten
          {# Energie-Defizit erwartet: Normal regeln #}
          {% elif bilanz < -500 %}
            normal
          {% else %}
            normal
          {% endif %}
        {% endif %}

    # =================================================================
    # SPOT-GRUND: Warum diese Empfehlung?
    # =================================================================
    - name: "EZHI Spot Grund"
      unique_id: ezhi_spot_grund
      state: >
        {% set rank = states('sensor.epex_spot_data_rank') | int(12) %}
        {% set quantile = states('sensor.epex_spot_data_quantile') | float(0.5) %}
        {% set pv_4h = states('sensor.ezhi_pv_prognose_4h') | int(0) %}
        {% set pv_morgen = states('sensor.solcast_pv_forecast_prognose_morgen') | float(0) %}
        {% set hour = now().hour %}
        {% set preis = states('sensor.epex_spot_data_market_price') | float(0) %}
        {% set bilanz = states('sensor.ezhi_energie_bilanz_4h') | int(0) %}
        {% set verbrauch_h = states('sensor.ezhi_erwarteter_verbrauch_stunde') | int(300) %}
        
        {% if rank <= 4 or quantile < 0.2 %}
          {% if bilanz > 2000 %}
            Billig ({{ preis | round(1) }}ct), aber +{{ (bilanz/1000) | round(1) }}kWh PV in 4h
          {% else %}
            Billigste Stunden (Rang {{ rank }}, {{ preis | round(1) }}ct) - Laden!
          {% endif %}
        {% elif rank >= 21 or quantile > 0.8 %}
          Teuerste Stunden (Rang {{ rank }}, {{ preis | round(1) }}ct) - Entladen!
        {% elif bilanz > 1000 %}
          PV-Überschuss in 4h (+{{ (bilanz/1000) | round(1) }}kWh) - Batterie schonen
        {% elif hour >= 18 and pv_morgen > 5 %}
          Abend, morgen {{ pv_morgen | round(1) }}kWh PV - Batterie schonen
        {% elif bilanz < -500 %}
          Defizit in 4h ({{ (bilanz/1000) | round(1) }}kWh) - Normal regeln
        {% else %}
          Normale Stunde (Rang {{ rank }}, ~{{ verbrauch_h }}Wh Verbrauch)
        {% endif %}

    # =================================================================
    # SPOT-SCORE: Numerischer Wert für Dashboard (-100 bis +100)
    # =================================================================
    - name: "EZHI Spot Score"
      unique_id: ezhi_spot_score
      unit_of_measurement: "%"
      state: >
        {% set action = states('sensor.ezhi_spot_action') %}
        {% set quantile = states('sensor.epex_spot_data_quantile') | float(0.5) %}
        {% if action == 'laden' %}
          {{ ((1 - quantile) * 100) | round(0) }}
        {% elif action == 'entladen' %}
          {{ (quantile * -100) | round(0) }}
        {% elif action == 'halten' %}
          0
        {% else %}
          {{ ((0.5 - quantile) * 50) | round(0) }}
        {% endif %}

    # =================================================================
    # DYNAMISCHES ENTLADE-LIMIT basierend auf Spot + Verbrauch
    # =================================================================
    - name: "EZHI Dynamisches Entlade-Limit"
      unique_id: ezhi_dynamic_discharge_limit
      unit_of_measurement: "%"
      state: >
        {% set basis = states('input_number.entlade_limit') | float(20) %}
        {% set action = states('sensor.ezhi_spot_action') %}
        {% set pv_morgen = states('sensor.solcast_pv_forecast_prognose_morgen') | float(0) %}
        {% set bilanz = states('sensor.ezhi_energie_bilanz_4h') | int(0) %}
        
        {% if action == 'entladen' %}
          {# Teuer: Tiefer entladen erlaubt #}
          {% if pv_morgen > 5 %}
            {# Morgen viel PV: Noch tiefer ok #}
            {{ (basis - 10) | max(5) }}
          {% elif bilanz > 0 %}
            {# Heute noch Überschuss erwartet #}
            {{ (basis - 7) | max(8) }}
          {% else %}
            {{ (basis - 5) | max(10) }}
          {% endif %}
        {% elif action == 'halten' %}
          {# Halten: Höheres Limit #}
          {{ (basis + 15) | min(50) }}
        {% else %}
          {{ basis }}
        {% endif %}

    # =================================================================
    # MAX SOC FÜR NETZLADEN (abhängig von PV + Verbrauch)
    # =================================================================
    - name: "EZHI Spot Netzladen Max SOC"
      unique_id: ezhi_spot_grid_charge_max_soc
      unit_of_measurement: "%"
      state: >
        {% set pv_4h = states('sensor.ezhi_pv_prognose_4h') | int(0) %}
        {% set pv_morgen = states('sensor.solcast_pv_forecast_prognose_morgen') | float(0) %}
        {% set hour = now().hour %}
        {% set bilanz = states('sensor.ezhi_energie_bilanz_4h') | int(0) %}
        {% set verbrauch_4h = state_attr('sensor.ezhi_erwarteter_verbrauch_stunde', 'naechste_4_stunden') | int(1200) %}
        
        {# Nachts (00-06): Mehr laden wenn morgen wenig PV oder hoher Verbrauch #}
        {% if hour < 6 %}
          {% if pv_morgen < 2 %}
            80
          {% elif pv_morgen < 5 and verbrauch_4h > 1500 %}
            70
          {% elif pv_morgen < 5 %}
            60
          {% else %}
            40
          {% endif %}
        
        {# Tagsüber: Weniger aus Netz, PV kommt #}
        {% else %}
          {% if bilanz < -1000 %}
            {# Großes Defizit erwartet #}
            60
          {% elif bilanz < 0 %}
            {# Leichtes Defizit #}
            40
          {% else %}
            {# Überschuss erwartet #}
            30
          {% endif %}
        {% endif %}
