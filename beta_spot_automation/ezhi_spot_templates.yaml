# ============================================================================
# EZHI Spot-Steuerung v1.1.0-beta - Template Sensoren
# ============================================================================
# Einbinden in configuration.yaml:
#
#   template: !include ezhi_spot_templates.yaml
#
# BENÖTIGT:
# - ezhi_spot_sql.yaml für Verbrauchsprofil
# - EPEX Spot Integration (HACS): https://github.com/mampfes/ha_epex_spot
# - Solcast Integration (HACS): https://github.com/BJReplay/ha-solcast-solar
#
# OPTIONAL:
# - Hausverbrauch-Sensor (siehe unten) für genaues Verbrauchsprofil
#
# CHANGELOG v1.1.0:
# - NEU: 5 Action-Zustände (pv_laden, netz_laden, entladen, halten, normal)
# - NEU: SOC-Grenzen-Schutz (≤15% / ≥90%)
# - NEU: MIN_SOC = 13% (EZHI Hardware-Minimum ist 12%)
# - FIX: sensor.battery_soc konsistent verwendet
# - FIX: Preisanzeige in ct/kWh (war €/kWh)
# - VERBESSERT: Intelligente Netzladen-Zielberechnung
# ============================================================================

- sensor:
    # =================================================================
    # HAUSVERBRAUCH TOTAL (OPTIONAL - für genaues Verbrauchsprofil)
    # =================================================================
    # Aktiviere diesen Sensor für ein genaues Verbrauchsprofil inkl.
    # PV-Eigenverbrauch. Ohne diesen Sensor zeigt das Profil nur Netzbezug.
    #
    # ANPASSEN: Ersetze die Sensor-Namen mit deinen eigenen!
    # Wenn du keinen Hausverbrauch-Sensor brauchst, lösche diesen Block.
    #
    # Formel: Netzbezug + PV + Batterie_Out - Einspeisung - Batterie_In
    #
    # WICHTIG: Batterie-Sensoren sind oft in kWh statt Wh!
    # =================================================================
    # - name: "Hausverbrauch Total"
    #   unique_id: hausverbrauch_total_wh
    #   unit_of_measurement: "Wh"
    #   device_class: energy
    #   state_class: total_increasing
    #   icon: mdi:home-lightning-bolt
    #   state: >
    #     {% set netzbezug = states('sensor.DEIN_SMARTMETER_IMPORT_WH') | float(0) %}
    #     {% set einspeisung = states('sensor.DEIN_SMARTMETER_EXPORT_WH') | float(0) %}
    #     {% set pv_total = states('sensor.DEIN_PV_LIFETIME_ENERGY_WH') | float(0) %}
    #     {# Batterie: Falls in kWh, dann * 1000 für Wh #}
    #     {% set batterie_out = states('sensor.DEIN_BATTERIE_DISCHARGE_KWH') | float(0) * 1000 %}
    #     {% set batterie_in = states('sensor.DEIN_BATTERIE_CHARGE_KWH') | float(0) * 1000 %}
    #     {{ (netzbezug + pv_total + batterie_out - einspeisung - batterie_in) | round(1) }}

    # =================================================================
    # VERBRAUCHSPROGNOSE aus SQL-Sensor
    # =================================================================
    - name: "EZHI Erwarteter Verbrauch Stunde"
      unique_id: ezhi_expected_consumption_hour
      unit_of_measurement: "Wh"
      icon: mdi:home-lightning-bolt
      state: >
        {% set data = state_attr('sensor.ezhi_verbrauchsprofil_7_tage', 'hourly_json') %}
        {% if data %}
          {% set json = data | from_json %}
          {% set hour = now().strftime('%H') %}
          {{ json.get(hour, 300) | int }}
        {% else %}
          300
        {% endif %}
      attributes:
        naechste_stunde: >
          {% set data = state_attr('sensor.ezhi_verbrauchsprofil_7_tage', 'hourly_json') %}
          {% if data %}
            {% set json = data | from_json %}
            {% set hour = '%02d' % ((now().hour + 1) % 24) %}
            {{ json.get(hour, 300) | int }}
          {% else %}
            300
          {% endif %}
        naechste_4_stunden: >
          {% set data = state_attr('sensor.ezhi_verbrauchsprofil_7_tage', 'hourly_json') %}
          {% if data %}
            {% set json = data | from_json %}
            {% set ns = namespace(total=0) %}
            {% for i in range(1, 5) %}
              {% set hour = '%02d' % ((now().hour + i) % 24) %}
              {% set ns.total = ns.total + (json.get(hour, 300) | int) %}
            {% endfor %}
            {{ ns.total }}
          {% else %}
            1200
          {% endif %}
        profil_json: "{{ state_attr('sensor.ezhi_verbrauchsprofil_7_tage', 'hourly_json') }}"

    # =================================================================
    # PV PROGNOSE NÄCHSTE 4 STUNDEN (aus Solcast detailedHourly)
    # =================================================================
    - name: "EZHI PV Prognose 4h"
      unique_id: ezhi_pv_forecast_4h
      unit_of_measurement: "Wh"
      icon: mdi:solar-power
      state: >
        {% set forecasts = state_attr('sensor.solcast_pv_forecast_prognose_heute', 'detailedHourly') %}
        {% if forecasts %}
          {% set now_hour = now().hour %}
          {% set today = now().strftime('%Y-%m-%d') %}
          {% set ns = namespace(total=0) %}
          {% for i in range(1, 5) %}
            {% set target_hour = (now_hour + i) % 24 %}
            {% set target_str = today ~ 'T' ~ '%02d' | format(target_hour) ~ ':00:00' %}
            {% for fc in forecasts %}
              {% set fc_time = fc.period_start | as_timestamp | timestamp_custom('%Y-%m-%dT%H:%M:%S', true) %}
              {% if fc_time is defined and target_str in fc_time %}
                {% set ns.total = ns.total + (fc.pv_estimate | float(0) * 1000) %}
              {% endif %}
            {% endfor %}
          {% endfor %}
          {{ ns.total | round(0) }}
        {% else %}
          0
        {% endif %}
      attributes:
        details: >
          {% set forecasts = state_attr('sensor.solcast_pv_forecast_prognose_heute', 'detailedHourly') %}
          {% if forecasts %}
            {% set now_hour = now().hour %}
            {% set today = now().strftime('%Y-%m-%d') %}
            {% set ns = namespace(hours=[]) %}
            {% for i in range(1, 5) %}
              {% set target_hour = (now_hour + i) % 24 %}
              {% set target_str = today ~ 'T' ~ '%02d' | format(target_hour) ~ ':00:00' %}
              {% for fc in forecasts %}
                {% set fc_time = fc.period_start | as_timestamp | timestamp_custom('%Y-%m-%dT%H:%M:%S', true) %}
                {% if fc_time is defined and target_str in fc_time %}
                  {% set ns.hours = ns.hours + [{'hour': target_hour, 'wh': (fc.pv_estimate | float(0) * 1000) | round(0)}] %}
                {% endif %}
              {% endfor %}
            {% endfor %}
            {{ ns.hours }}
          {% else %}
            []
          {% endif %}

    # =================================================================
    # ENERGIE-BILANZ: PV vs. Verbrauch für nächste 4 Stunden
    # =================================================================
    - name: "EZHI Energie Bilanz 4h"
      unique_id: ezhi_energy_balance_4h
      unit_of_measurement: "Wh"
      icon: mdi:scale-balance
      state: >
        {% set pv_4h = states('sensor.ezhi_pv_prognose_4h') | int(0) %}
        {% set verbrauch_4h = state_attr('sensor.ezhi_erwarteter_verbrauch_stunde', 'naechste_4_stunden') | int(1200) %}
        {{ (pv_4h - verbrauch_4h) | round(0) }}
      attributes:
        pv_erwartet_wh: "{{ states('sensor.ezhi_pv_prognose_4h') | int(0) }}"
        verbrauch_erwartet_wh: "{{ state_attr('sensor.ezhi_erwarteter_verbrauch_stunde', 'naechste_4_stunden') | int(1200) }}"
        bewertung: >
          {% set bilanz = states('sensor.ezhi_energie_bilanz_4h') | int(0) %}
          {% if bilanz > 2000 %}
            Überschuss
          {% elif bilanz > 0 %}
            Ausgeglichen
          {% elif bilanz > -1000 %}
            Leichtes Defizit
          {% else %}
            Defizit
          {% endif %}

    # =================================================================
    # PV ÜBERSCHUSS START: Wann ist PV > Verbrauch?
    # =================================================================
    # Berechnet die Stunde, ab der PV-Produktion den Verbrauch übersteigt.
    # Wichtig für realistische Entlade-Entscheidungen!
    #
    # Beispiel Winter 08:00:
    #   PV: 200W, Verbrauch: 300W → Noch kein Überschuss
    # Beispiel Winter 10:00:
    #   PV: 800W, Verbrauch: 500W → Überschuss ab hier!
    # =================================================================
    - name: "EZHI PV Überschuss Start"
      unique_id: ezhi_pv_surplus_start
      icon: mdi:weather-sunny-alert
      state: >
        {% set forecasts_heute = state_attr('sensor.solcast_pv_forecast_prognose_heute', 'detailedHourly') %}
        {% set forecasts_morgen = state_attr('sensor.solcast_pv_forecast_prognose_morgen', 'detailedHourly') %}
        {% set profil_raw = state_attr('sensor.ezhi_verbrauchsprofil_7_tage', 'hourly_json') %}
        {% set profil = profil_raw | from_json if profil_raw else {} %}
        {% set current_hour = now().hour %}
        {% set ns = namespace(found_hour=12, checked_tomorrow=false) %}
        
        {# Heute durchsuchen #}
        {% if forecasts_heute and profil %}
          {% for fc in forecasts_heute %}
            {% set fc_hour = fc.period_start | as_timestamp | timestamp_custom('%H', true) | int %}
            {% if fc_hour > current_hour %}
              {% set pv_wh = (fc.pv_estimate | float(0) * 1000) | int %}
              {% set verbrauch_wh = profil.get('%02d' % fc_hour, 300) | float(300) | int %}
              {% if pv_wh > verbrauch_wh and ns.found_hour == 12 %}
                {% set ns.found_hour = fc_hour %}
              {% endif %}
            {% endif %}
          {% endfor %}
        {% endif %}
        
        {# Wenn heute kein Überschuss gefunden, morgen prüfen #}
        {% if ns.found_hour == 12 and forecasts_morgen and profil %}
          {% for fc in forecasts_morgen %}
            {% set fc_hour = fc.period_start | as_timestamp | timestamp_custom('%H', true) | int %}
            {% set pv_wh = (fc.pv_estimate | float(0) * 1000) | int %}
            {% set verbrauch_wh = profil.get('%02d' % fc_hour, 300) | float(300) | int %}
            {% if pv_wh > verbrauch_wh %}
              {% set ns.found_hour = fc_hour %}
              {% set ns.checked_tomorrow = true %}
              {% break %}
            {% endif %}
          {% endfor %}
        {% endif %}
        
        {{ ns.found_hour }}
      attributes:
        ist_morgen: >
          {% set forecasts_heute = state_attr('sensor.solcast_pv_forecast_prognose_heute', 'detailedHourly') %}
          {% set forecasts_morgen = state_attr('sensor.solcast_pv_forecast_prognose_morgen', 'detailedHourly') %}
          {% set profil_raw = state_attr('sensor.ezhi_verbrauchsprofil_7_tage', 'hourly_json') %}
          {% set profil = profil_raw | from_json if profil_raw else {} %}
          {% set current_hour = now().hour %}
          {% set ns = namespace(found_today=false) %}
          {% if forecasts_heute and profil %}
            {% for fc in forecasts_heute %}
              {% set fc_hour = fc.period_start | as_timestamp | timestamp_custom('%H', true) | int %}
              {% if fc_hour > current_hour %}
                {% set pv_wh = (fc.pv_estimate | float(0) * 1000) | int %}
                {% set verbrauch_wh = profil.get('%02d' % fc_hour, 300) | float(300) | int %}
                {% if pv_wh > verbrauch_wh %}
                  {% set ns.found_today = true %}
                  {% break %}
                {% endif %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {{ not ns.found_today }}
        
        stunden_bis_ueberschuss: >
          {% set start_hour = states('sensor.ezhi_pv_ueberschuss_start') | int(12) %}
          {% set current_hour = now().hour %}
          {% set ist_morgen = state_attr('sensor.ezhi_pv_ueberschuss_start', 'ist_morgen') %}
          {% if ist_morgen %}
            {{ (24 - current_hour) + start_hour }}
          {% elif start_hour > current_hour %}
            {{ start_hour - current_hour }}
          {% else %}
            0
          {% endif %}
        
        verbrauch_bis_ueberschuss_wh: >
          {% set start_hour = states('sensor.ezhi_pv_ueberschuss_start') | int(12) %}
          {% set current_hour = now().hour %}
          {% set ist_morgen = state_attr('sensor.ezhi_pv_ueberschuss_start', 'ist_morgen') %}
          {% set profil_raw = state_attr('sensor.ezhi_verbrauchsprofil_7_tage', 'hourly_json') %}
          {% set profil = profil_raw | from_json if profil_raw else {} %}
          {% set ns = namespace(total=0) %}
          
          {% if ist_morgen %}
            {% set stunden = (24 - current_hour) + start_hour %}
          {% elif start_hour > current_hour %}
            {% set stunden = start_hour - current_hour %}
          {% else %}
            {% set stunden = 0 %}
          {% endif %}
          
          {% for i in range(stunden) %}
            {% set h = '%02d' % ((current_hour + i) % 24) %}
            {% set ns.total = ns.total + (profil.get(h, 300) | float(300)) %}
          {% endfor %}
          {{ ns.total | int }}

    # =================================================================
    # SPOT-BEWERTUNG: Kombiniert Preis + PV + Verbrauch
    # =================================================================
    - name: "EZHI Spot Empfehlung"
      unique_id: ezhi_spot_recommendation
      icon: >
        {% set action = states('sensor.ezhi_spot_action') %}
        {% if action in ['pv_laden', 'netz_laden'] %}
          mdi:battery-charging
        {% elif action == 'entladen' %}
          mdi:battery-arrow-down
        {% elif action == 'halten' %}
          mdi:battery-lock
        {% else %}
          mdi:battery
        {% endif %}
      state: "{{ states('sensor.ezhi_spot_action') }}"
      attributes:
        spot_preis_ct: "{{ (states('sensor.epex_spot_data_market_price') | float(0) * 100) | round(2) }}"
        spot_rank: "{{ states('sensor.epex_spot_data_rank') | int(12) }}"
        spot_quantile: "{{ states('sensor.epex_spot_data_quantile') | float(0.5) }}"
        pv_4h_wh: "{{ states('sensor.ezhi_pv_prognose_4h') | int(0) }}"
        pv_rest_heute_kwh: "{{ states('sensor.solcast_pv_forecast_prognose_verbleibende_leistung_heute') | float(0) }}"
        pv_morgen_kwh: "{{ states('sensor.solcast_pv_forecast_prognose_morgen') | float(0) }}"
        verbrauch_stunde_wh: "{{ states('sensor.ezhi_erwarteter_verbrauch_stunde') | int(300) }}"
        verbrauch_4h_wh: "{{ state_attr('sensor.ezhi_erwarteter_verbrauch_stunde', 'naechste_4_stunden') | int(1200) }}"
        energie_bilanz_wh: "{{ states('sensor.ezhi_energie_bilanz_4h') | int(0) }}"
        grund: "{{ states('sensor.ezhi_spot_grund') }}"

    # =================================================================
    # SPOT-AKTION: Was soll die Batterie tun?
    # =================================================================
    # 5 ZUSTÄNDE:
    # - pv_laden:   PV-Überschuss → Laden auf 100% (kostenlos!)
    # - netz_laden: Kein PV, günstig → Laden aus Netz auf berechnetes Ziel
    # - entladen:   Teuer + Reserve + PV kommt + GENUG PUFFER → Entladen
    # - halten:     Reserve halten (kein Entladen)
    # - normal:     EZHI selbst regeln lassen
    #
    # PRIORITÄT:
    # 1. SOC-Grenzen prüfen (leer/voll)
    # 2. PV-Situation prüfen (PV-Laden hat Vorrang!)
    # 3. Energie-Puffer prüfen (reicht Batterie bis PV-Überschuss?)
    # 4. Dann erst Preis bewerten für Netzladen/Entladen
    #
    # ENTLADE-PUFFER: 350Wh Sicherheitsreserve
    # =================================================================
    - name: "EZHI Spot Action"
      unique_id: ezhi_spot_action
      state: >
        {% set quantile = states('sensor.epex_spot_data_quantile') | float(0.5) %}
        {% set soc = states('sensor.battery_soc') | int(50) %}
        {% set pv_4h = states('sensor.ezhi_pv_prognose_4h') | int(0) %}
        {% set pv_rest_heute = states('sensor.solcast_pv_forecast_prognose_verbleibende_leistung_heute') | float(0) %}
        {% set pv_morgen = states('sensor.solcast_pv_forecast_prognose_morgen') | float(0) %}
        {% set hour = now().hour %}
        {% set bilanz = states('sensor.ezhi_energie_bilanz_4h') | int(0) %}
        
        {# === KONSTANTEN === #}
        {% set MIN_SOC = 12 %}
        {% set ENTLADE_PUFFER = 350 %}
        
        {# === BATTERIEKAPAZITÄT === #}
        {% set bat_cap = states('sensor.ezhi_battery_capacity') | float(4800) %}
        
        {# === VERFÜGBARE ENERGIE (Wh) === #}
        {% set verfuegbar_wh = ((soc - MIN_SOC) / 100 * bat_cap) | int %}
        {% set verfuegbar_wh = [verfuegbar_wh, 0] | max %}
        
        {# === VERBRAUCH BIS PV-ÜBERSCHUSS (aus neuem Sensor) === #}
        {% set verbrauch_bis_pv = state_attr('sensor.ezhi_pv_ueberschuss_start', 'verbrauch_bis_ueberschuss_wh') | int(1500) %}
        
        {# === ENERGIE-PUFFER CHECK === #}
        {% set energie_reicht = (verfuegbar_wh > (verbrauch_bis_pv + ENTLADE_PUFFER)) %}
        {% set energie_puffer_wh = verfuegbar_wh - verbrauch_bis_pv %}
        
        {# === PV AKTIV? (> 100W in nächster Stunde) === #}
        {% set pv_aktiv = pv_4h > 100 %}
        
        {# === BATTERIE FAST LEER (≤15%) - NIEMALS ENTLADEN === #}
        {% if soc <= 15 %}
          {% if pv_aktiv %}
            pv_laden
          {% elif quantile < 0.3 %}
            netz_laden
          {% else %}
            halten
          {% endif %}
        
        {# === BATTERIE FAST VOLL (≥90%) === #}
        {% elif soc >= 90 %}
          {% if pv_aktiv and soc < 100 %}
            pv_laden
          {% elif quantile > 0.7 and (pv_rest_heute > 2 or pv_morgen > 3) %}
            entladen
          {% else %}
            normal
          {% endif %}
        
        {# === PV AKTIV - IMMER PV-LADEN BIS 100% === #}
        {% elif pv_aktiv and bilanz > 0 %}
          pv_laden
        
        {# === KEIN PV - PREISBASIERTE ENTSCHEIDUNG === #}
        {% else %}
          {# Sehr billig (Top 20%) + Defizit erwartet → Netzladen #}
          {% if quantile < 0.2 and bilanz < 500 %}
            netz_laden
          
          {# Billig (Top 30%) + großes Defizit → Netzladen #}
          {% elif quantile < 0.3 and bilanz < -500 %}
            netz_laden
          
          {# Teuer (Top 30%) + PV kommt + GENUG PUFFER #}
          {% elif quantile > 0.7 and soc > 30 and (pv_rest_heute > 2 or pv_morgen > 3) %}
            {% if energie_reicht %}
              entladen
            {% else %}
              halten
            {% endif %}
          
          {# Teuer aber nicht genug PV erwartet #}
          {% elif quantile > 0.7 and soc > 30 %}
            halten
          
          {# Mittelpreis oder keine klare Situation #}
          {% else %}
            normal
          {% endif %}
        {% endif %}
      attributes:
        ladequelle: >
          {% set action = states('sensor.ezhi_spot_action') %}
          {% if action == 'pv_laden' %}
            PV (kostenlos)
          {% elif action == 'netz_laden' %}
            Netz (Spot-Preis)
          {% else %}
            Keine
          {% endif %}
        
        ladeziel_soc: >
          {% set action = states('sensor.ezhi_spot_action') %}
          {% if action == 'pv_laden' %}
            100
          {% elif action == 'netz_laden' %}
            {{ states('sensor.ezhi_spot_netzladen_max_soc') | int(50) }}
          {% else %}
            {{ states('sensor.battery_soc') | int(50) }}
          {% endif %}
        
        pv_aktiv: "{{ states('sensor.ezhi_pv_prognose_4h') | int(0) > 100 }}"
        pv_rest_heute_kwh: "{{ states('sensor.solcast_pv_forecast_prognose_verbleibende_leistung_heute') | float(0) | round(1) }}"
        pv_morgen_kwh: "{{ states('sensor.solcast_pv_forecast_prognose_morgen') | float(0) | round(1) }}"
        
        # Energie-Puffer Berechnung
        verfuegbar_wh: >
          {% set soc = states('sensor.battery_soc') | int(50) %}
          {% set bat_cap = states('sensor.ezhi_battery_capacity') | float(4800) %}
          {% set verfuegbar = ((soc - 12) / 100 * bat_cap) | int %}
          {{ [verfuegbar, 0] | max }}
        verbrauch_bis_pv_wh: "{{ state_attr('sensor.ezhi_pv_ueberschuss_start', 'verbrauch_bis_ueberschuss_wh') | int(0) }}"
        energie_puffer_wh: >
          {% set soc = states('sensor.battery_soc') | int(50) %}
          {% set bat_cap = states('sensor.ezhi_battery_capacity') | float(4800) %}
          {% set verfuegbar = [((soc - 12) / 100 * bat_cap) | int, 0] | max %}
          {% set verbrauch = state_attr('sensor.ezhi_pv_ueberschuss_start', 'verbrauch_bis_ueberschuss_wh') | int(0) %}
          {{ verfuegbar - verbrauch }}
        energie_reicht_fuer_entladen: >
          {% set soc = states('sensor.battery_soc') | int(50) %}
          {% set bat_cap = states('sensor.ezhi_battery_capacity') | float(4800) %}
          {% set verfuegbar = [((soc - 12) / 100 * bat_cap) | int, 0] | max %}
          {% set verbrauch = state_attr('sensor.ezhi_pv_ueberschuss_start', 'verbrauch_bis_ueberschuss_wh') | int(0) %}
          {{ verfuegbar > (verbrauch + 350) }}

    # =================================================================
    # SPOT-GRUND: Warum diese Empfehlung?
    # =================================================================
    - name: "EZHI Spot Grund"
      unique_id: ezhi_spot_grund
      state: >
        {% set action = states('sensor.ezhi_spot_action') %}
        {% set quantile = states('sensor.epex_spot_data_quantile') | float(0.5) %}
        {% set soc = states('sensor.battery_soc') | int(50) %}
        {% set pv_4h = states('sensor.ezhi_pv_prognose_4h') | int(0) %}
        {% set pv_rest = states('sensor.solcast_pv_forecast_prognose_verbleibende_leistung_heute') | float(0) %}
        {% set pv_morgen = states('sensor.solcast_pv_forecast_prognose_morgen') | float(0) %}
        {% set preis = (states('sensor.epex_spot_data_market_price') | float(0) * 100) | round(1) %}
        {% set bilanz = states('sensor.ezhi_energie_bilanz_4h') | int(0) %}
        {% set ziel = state_attr('sensor.ezhi_spot_action', 'ladeziel_soc') | int(soc) %}
        
        {# Energie-Puffer Werte #}
        {% set energie_puffer = state_attr('sensor.ezhi_spot_action', 'energie_puffer_wh') | int(0) %}
        {% set energie_reicht = state_attr('sensor.ezhi_spot_action', 'energie_reicht_fuer_entladen') %}
        
        {% if action == 'pv_laden' %}
          PV-Überschuss → Lade auf 100% (kostenlos!)
        {% elif action == 'netz_laden' %}
          Günstig ({{ preis }}ct, Q{{ (quantile*100)|round(0) }}%) → Netzladen auf {{ ziel }}%
        {% elif action == 'entladen' %}
          Teuer ({{ preis }}ct) + {% if pv_rest > 2 %}{{ pv_rest|round(1) }}kWh PV heute{% else %}{{ pv_morgen|round(1) }}kWh PV morgen{% endif %} + Puffer {{ energie_puffer }}Wh → Entladen
        {% elif action == 'halten' %}
          {% if soc <= 15 %}
            Batterie leer ({{ soc }}%) - Warte auf günstigere Preise
          {% elif quantile > 0.7 and (pv_rest > 2 or pv_morgen > 3) and not energie_reicht %}
            Teuer + PV kommt, aber Puffer nur {{ energie_puffer }}Wh (<350Wh) → Halten
          {% elif quantile > 0.7 %}
            Teuer aber wenig PV erwartet → Reserve halten
          {% else %}
            Mittlerer Preis ({{ preis }}ct) → Batterie schonen
          {% endif %}
        {% else %}
          Normal ({{ preis }}ct, SOC {{ soc }}%)
        {% endif %}

    # =================================================================
    # SPOT-SCORE: Numerischer Wert für Dashboard (-100 bis +100)
    # =================================================================
    - name: "EZHI Spot Score"
      unique_id: ezhi_spot_score
      unit_of_measurement: "%"
      state: >
        {% set action = states('sensor.ezhi_spot_action') %}
        {% set quantile = states('sensor.epex_spot_data_quantile') | float(0.5) %}
        {% if action in ['pv_laden', 'netz_laden'] %}
          {{ ((1 - quantile) * 100) | round(0) }}
        {% elif action == 'entladen' %}
          {{ (quantile * -100) | round(0) }}
        {% elif action == 'halten' %}
          0
        {% else %}
          {{ ((0.5 - quantile) * 50) | round(0) }}
        {% endif %}

    # =================================================================
    # DYNAMISCHES ENTLADE-LIMIT basierend auf SOC + Spot + PV
    # =================================================================
    # WICHTIG: EZHI schaltet bei 12% selbst ab!
    # Daher ist 13% das absolute Minimum (mit Puffer)
    # =================================================================
    - name: "EZHI Dynamisches Entlade-Limit"
      unique_id: ezhi_dynamic_discharge_limit
      unit_of_measurement: "%"
      state: >
        {% set basis = states('input_number.entlade_limit') | float(20) %}
        {% set action = states('sensor.ezhi_spot_action') %}
        {% set soc = states('sensor.battery_soc') | int(50) %}
        {% set pv_morgen = states('sensor.solcast_pv_forecast_prognose_morgen') | float(0) %}
        {% set bilanz = states('sensor.ezhi_energie_bilanz_4h') | int(0) %}
        {% set hour = now().hour %}
        {% set MIN_SOC = 13 %}
        
        {# ================================================================= #}
        {# v1.1.1: Limit wird NUR bei 'entladen' gesenkt!                    #}
        {# Bei allen anderen Zuständen (pv_laden, netz_laden, halten,        #}
        {# normal) gilt das Basis-Limit.                                     #}
        {# GRUND: Limit erhöhen bei 'halten' führte zu teurem Netzbezug!    #}
        {# ================================================================= #}
        
        {# Entladen-Empfehlung: Tieferes Limit erlaubt, aber nie unter MIN_SOC #}
        {% if action == 'entladen' %}
          {% if pv_morgen > 5 %}
            {{ [basis - 10, MIN_SOC] | max }}
          {% elif bilanz > 0 %}
            {{ [basis - 7, MIN_SOC] | max }}
          {% else %}
            {{ [basis - 5, MIN_SOC] | max }}
          {% endif %}
        
        {# Alle anderen Zustände: Basis-Limit (nie unter MIN_SOC) #}
        {% else %}
          {{ [basis, MIN_SOC] | max }}
        {% endif %}

    # =================================================================
    # MAX SOC FÜR NETZLADEN - INTELLIGENT
    # =================================================================
    # Berechnet das optimale Ladeziel basierend auf:
    # - Verbrauch bis PV verfügbar (aus Stundenprofil)
    # - Aktueller SOC und verfügbare Energie
    # - Billigstrom-Bonus bei sehr günstigen Preisen
    #
    # KONSTANTEN (anpassen!):
    # - BATTERIE_KAPAZITAET: Deine Batteriekapazität in Wh
    # - MIN_SOC: EZHI Minimum (12%) + Puffer
    # =================================================================
    - name: "EZHI Spot Netzladen Max SOC"
      unique_id: ezhi_spot_grid_charge_max_soc
      unit_of_measurement: "%"
      state: >
        {# === BATTERIEKAPAZITÄT AUS SENSOR === #}
        {% set BATTERIE_KAPAZITAET = states('sensor.ezhi_battery_capacity') | float(4800) %}
        {% set MIN_SOC = 12 %}
        {% set PUFFER_STUNDEN = 1 %}
        {% set DEFAULT_VERBRAUCH_H = 200 %}
        
        {# === AKTUELLE WERTE === #}
        {% set soc = states('sensor.battery_soc') | int(50) %}
        {% set hour = now().hour %}
        {% set quantile = states('sensor.epex_spot_data_quantile') | float(0.5) %}
        
        {# === VERBRAUCHSPROFIL LADEN === #}
        {% set profil_raw = state_attr('sensor.ezhi_verbrauchsprofil_7_tage', 'hourly_json') %}
        {% if profil_raw %}
          {% set profil = profil_raw | from_json if profil_raw is string else profil_raw %}
        {% else %}
          {% set profil = {} %}
        {% endif %}
        
        {# === PV PROGNOSE - WANN KOMMT RELEVANTE PV (> 100W)? === #}
        {% set forecasts = state_attr('sensor.solcast_pv_forecast_prognose_heute', 'detailedHourly') %}
        {% set ns = namespace(pv_start_hour=8) %}
        {% if forecasts %}
          {% for fc in forecasts %}
            {% if fc.pv_estimate | float(0) > 0.1 %}
              {% set fc_hour = fc.period_start | as_timestamp | timestamp_custom('%H', true) | int %}
              {% set ns.pv_start_hour = fc_hour %}
              {% break %}
            {% endif %}
          {% endfor %}
        {% endif %}
        
        {# === BERECHNE STUNDEN BIS PV === #}
        {% if hour >= ns.pv_start_hour %}
          {% set stunden_bis_pv = (24 - hour) + ns.pv_start_hour %}
        {% else %}
          {% set stunden_bis_pv = ns.pv_start_hour - hour %}
        {% endif %}
        
        {# === SUMMIERE VERBRAUCH BIS PV + PUFFER === #}
        {% set ns = namespace(verbrauch_total=0) %}
        {% for i in range(stunden_bis_pv + PUFFER_STUNDEN) %}
          {% set h = '%02d' % ((hour + i) % 24) %}
          {% set verbrauch_h = profil.get(h, DEFAULT_VERBRAUCH_H) | float(DEFAULT_VERBRAUCH_H) %}
          {% set ns.verbrauch_total = ns.verbrauch_total + verbrauch_h %}
        {% endfor %}
        
        {# === BERECHNE VERFÜGBARE ENERGIE (über Min-SOC) === #}
        {% set verfuegbar_wh = ((soc - MIN_SOC) / 100 * BATTERIE_KAPAZITAET) | round(0) %}
        {% set verfuegbar_wh = [verfuegbar_wh, 0] | max %}
        
        {# === BERECHNE DEFIZIT === #}
        {% set defizit_wh = ns.verbrauch_total - verfuegbar_wh %}
        
        {# === BERECHNE ZIEL-SOC === #}
        {% if defizit_wh > 0 %}
          {% set zusatz_soc = (defizit_wh / BATTERIE_KAPAZITAET * 100) | round(1) %}
          {% set ziel_soc = soc + zusatz_soc %}
        {% else %}
          {% set ziel_soc = soc %}
        {% endif %}
        
        {# === BILLIGSTROM-BONUS === #}
        {% if quantile < 0.1 %}
          {% set ziel_soc = ziel_soc + 25 %}
        {% elif quantile < 0.2 %}
          {% set ziel_soc = ziel_soc + 15 %}
        {% elif quantile < 0.3 %}
          {% set ziel_soc = ziel_soc + 5 %}
        {% endif %}
        
        {# === GRENZEN ANWENDEN === #}
        {{ [[ziel_soc | round(0), MIN_SOC] | max, 100] | min | int }}
      attributes:
        batterie_kapazitaet_wh: "{{ states('sensor.ezhi_battery_capacity') | float(4800) | int }}"
        nutzbar_wh: "{{ (states('sensor.ezhi_battery_capacity') | float(4800) * 0.88) | int }}"
        min_soc_prozent: 12
        puffer_stunden: 1
        aktueller_soc: "{{ states('sensor.battery_soc') | int(50) }}"
        
        pv_start_stunde: >
          {% set forecasts = state_attr('sensor.solcast_pv_forecast_prognose_heute', 'detailedHourly') %}
          {% set ns = namespace(pv_start=8) %}
          {% if forecasts %}
            {% for fc in forecasts %}
              {% if fc.pv_estimate | float(0) > 0.1 %}
                {% set ns.pv_start = fc.period_start | as_timestamp | timestamp_custom('%H', true) | int %}
                {% break %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {{ ns.pv_start }}
        
        stunden_bis_pv: >
          {% set hour = now().hour %}
          {% set forecasts = state_attr('sensor.solcast_pv_forecast_prognose_heute', 'detailedHourly') %}
          {% set ns = namespace(pv_start=8) %}
          {% if forecasts %}
            {% for fc in forecasts %}
              {% if fc.pv_estimate | float(0) > 0.1 %}
                {% set ns.pv_start = fc.period_start | as_timestamp | timestamp_custom('%H', true) | int %}
                {% break %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {% if hour >= ns.pv_start %}
            {{ (24 - hour) + ns.pv_start }}
          {% else %}
            {{ ns.pv_start - hour }}
          {% endif %}
        
        billigstrom_bonus_prozent: >
          {% set quantile = states('sensor.epex_spot_data_quantile') | float(0.5) %}
          {% if quantile < 0.1 %}25
          {% elif quantile < 0.2 %}15
          {% elif quantile < 0.3 %}5
          {% else %}0{% endif %}
        
        erklaerung: >
          {% set soc = states('sensor.battery_soc') | int(50) %}
          {% set ziel = states('sensor.ezhi_spot_netzladen_max_soc') | int(50) %}
          {% set bonus = state_attr('sensor.ezhi_spot_netzladen_max_soc', 'billigstrom_bonus_prozent') | int(0) %}
          {% if ziel > soc and bonus > 0 %}
            Mit Billigstrom-Bonus ({{ bonus }}%) → Ziel {{ ziel }}%
          {% elif ziel > soc %}
            Defizit erwartet → Lade auf {{ ziel }}%
          {% else %}
            Aktueller SOC {{ soc }}% reicht bis PV
          {% endif %}

    # =================================================================
    # STROMPREIS IN CT/KWH (für Dashboard)
    # =================================================================
    - name: "Strompreis ct"
      unique_id: strompreis_ct_kwh
      unit_of_measurement: "ct/kWh"
      icon: mdi:currency-eur
      state: "{{ (states('sensor.epex_spot_data_market_price') | float(0) * 100) | round(2) }}"
      attributes:
        euro_kwh: "{{ states('sensor.epex_spot_data_market_price') | float(0) | round(4) }}"
        rang: "{{ states('sensor.epex_spot_data_rank') | int(0) }}"
        quantile: "{{ states('sensor.epex_spot_data_quantile') | float(0) | round(2) }}"

    # =================================================================
    # VORAUSSCHAUENDER LADEPLAN
    # =================================================================
    - name: "EZHI Ladeplan"
      unique_id: ezhi_charge_plan
      icon: mdi:calendar-clock
      state: >
        {% set data = state_attr('sensor.epex_spot_data_market_price', 'data') %}
        {% if data and data | length > 0 %}
          {% set now_ts = now() | as_timestamp %}
          {% set ns = namespace(cheapest_price=999, cheapest_time='') %}
          {% for item in data %}
            {% set start_ts = item.start_time | as_timestamp %}
            {% if start_ts > now_ts and item.price_per_kwh < ns.cheapest_price %}
              {% set ns.cheapest_price = item.price_per_kwh %}
              {% set ns.cheapest_time = item.start_time %}
            {% endif %}
          {% endfor %}
          {% if ns.cheapest_time != '' %}
            {{ (ns.cheapest_time | as_timestamp | timestamp_custom('%H:%M', true)) }}
          {% else %}
            Keine Daten
          {% endif %}
        {% else %}
          Keine Daten
        {% endif %}
      attributes:
        aktueller_preis_ct: "{{ (states('sensor.epex_spot_data_market_price') | float(0) * 100) | round(2) }}"
        
        billigste_zeit: >
          {% set data = state_attr('sensor.epex_spot_data_market_price', 'data') %}
          {% if data %}
            {% set now_ts = now() | as_timestamp %}
            {% set ns = namespace(cheapest_price=999, cheapest_time='') %}
            {% for item in data %}
              {% set start_ts = item.start_time | as_timestamp %}
              {% if start_ts > now_ts and item.price_per_kwh < ns.cheapest_price %}
                {% set ns.cheapest_price = item.price_per_kwh %}
                {% set ns.cheapest_time = item.start_time %}
              {% endif %}
            {% endfor %}
            {{ ns.cheapest_time | as_timestamp | timestamp_custom('%d.%m %H:%M', true) if ns.cheapest_time else 'N/A' }}
          {% else %}
            N/A
          {% endif %}
        
        billigster_preis_ct: >
          {% set data = state_attr('sensor.epex_spot_data_market_price', 'data') %}
          {% if data %}
            {% set now_ts = now() | as_timestamp %}
            {% set ns = namespace(min_price=999) %}
            {% for item in data %}
              {% if item.start_time | as_timestamp > now_ts %}
                {% if item.price_per_kwh < ns.min_price %}
                  {% set ns.min_price = item.price_per_kwh %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {{ (ns.min_price * 100) | round(2) if ns.min_price < 999 else 0 }}
          {% else %}
            0
          {% endif %}
        
        teuerste_zeit: >
          {% set data = state_attr('sensor.epex_spot_data_market_price', 'data') %}
          {% if data %}
            {% set now_ts = now() | as_timestamp %}
            {% set ns = namespace(highest_price=-999, highest_time='') %}
            {% for item in data %}
              {% set start_ts = item.start_time | as_timestamp %}
              {% if start_ts > now_ts and item.price_per_kwh > ns.highest_price %}
                {% set ns.highest_price = item.price_per_kwh %}
                {% set ns.highest_time = item.start_time %}
              {% endif %}
            {% endfor %}
            {{ ns.highest_time | as_timestamp | timestamp_custom('%d.%m %H:%M', true) if ns.highest_time else 'N/A' }}
          {% else %}
            N/A
          {% endif %}
        
        teuerster_preis_ct: >
          {% set data = state_attr('sensor.epex_spot_data_market_price', 'data') %}
          {% if data %}
            {% set now_ts = now() | as_timestamp %}
            {% set ns = namespace(max_price=-999) %}
            {% for item in data %}
              {% if item.start_time | as_timestamp > now_ts %}
                {% if item.price_per_kwh > ns.max_price %}
                  {% set ns.max_price = item.price_per_kwh %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {{ (ns.max_price * 100) | round(2) if ns.max_price > -999 else 0 }}
          {% else %}
            0
          {% endif %}
        
        durchschnitt_ct: >
          {% set data = state_attr('sensor.epex_spot_data_market_price', 'data') %}
          {% if data %}
            {% set now_ts = now() | as_timestamp %}
            {% set ns = namespace(total=0, count=0) %}
            {% for item in data %}
              {% if item.start_time | as_timestamp > now_ts %}
                {% set ns.total = ns.total + item.price_per_kwh %}
                {% set ns.count = ns.count + 1 %}
              {% endif %}
            {% endfor %}
            {{ ((ns.total / ns.count) * 100) | round(2) if ns.count > 0 else 0 }}
          {% else %}
            0
          {% endif %}
        
        ersparnis_ct_kwh: >
          {% set aktuell = states('sensor.epex_spot_data_market_price') | float(0) %}
          {% set data = state_attr('sensor.epex_spot_data_market_price', 'data') %}
          {% if data %}
            {% set now_ts = now() | as_timestamp %}
            {% set ns = namespace(min_price=999) %}
            {% for item in data %}
              {% if item.start_time | as_timestamp > now_ts %}
                {% if item.price_per_kwh < ns.min_price %}
                  {% set ns.min_price = item.price_per_kwh %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {% set min_price = ns.min_price if ns.min_price < 999 else aktuell %}
            {{ ((aktuell - min_price) * 100) | round(2) }}
          {% else %}
            0
          {% endif %}
        
        batterie_soc: "{{ states('sensor.battery_soc') | int(50) }}"
        batterie_kapazitaet_wh: "{{ states('sensor.ezhi_battery_capacity') | float(4800) | int }}"
        batterie_ladekapazitaet_wh: >
          {% set soc = states('sensor.battery_soc') | int(50) %}
          {% set cap = states('sensor.ezhi_battery_capacity') | float(4800) %}
          {{ ((100 - soc) / 100 * cap) | round(0) }}
        
        pv_morgen_kwh: "{{ states('sensor.solcast_pv_forecast_prognose_morgen') | float(0) | round(1) }}"
        
        empfehlung: >
          {% set aktuell = states('sensor.epex_spot_data_market_price') | float(0) * 100 %}
          {% set data = state_attr('sensor.epex_spot_data_market_price', 'data') %}
          {% set soc = states('sensor.battery_soc') | int(50) %}
          {% set pv_morgen = states('sensor.solcast_pv_forecast_prognose_morgen') | float(0) %}
          {% set hour = now().hour %}
          
          {% if data %}
            {% set now_ts = now() | as_timestamp %}
            {% set ns = namespace(min_price=999, total=0, count=0) %}
            {% for item in data %}
              {% if item.start_time | as_timestamp > now_ts %}
                {% if item.price_per_kwh < ns.min_price %}
                  {% set ns.min_price = item.price_per_kwh %}
                {% endif %}
                {% set ns.total = ns.total + item.price_per_kwh %}
                {% set ns.count = ns.count + 1 %}
              {% endif %}
            {% endfor %}
            {% set min_price = (ns.min_price * 100) if ns.min_price < 999 else aktuell %}
            {% set avg_price = ((ns.total / ns.count) * 100) if ns.count > 0 else aktuell %}
            
            {% if soc >= 95 %}
              Batterie voll - kein Laden nötig
            {% elif aktuell <= min_price * 1.05 %}
              JETZT LADEN - Preis nahe Minimum ({{ aktuell | round(1) }}ct)
            {% elif aktuell < avg_price * 0.8 %}
              Günstig - Laden empfohlen ({{ aktuell | round(1) }}ct)
            {% elif hour >= 22 or hour < 6 %}
              {% if pv_morgen > 5 %}
                Nachts - morgen {{ pv_morgen | round(1) }}kWh PV, wenig laden
              {% else %}
                Nachts - wenig PV morgen, Netzladen prüfen
              {% endif %}
            {% elif pv_morgen > 5 and soc > 30 %}
              Warten auf PV morgen ({{ pv_morgen | round(1) }}kWh)
            {% else %}
              Warten auf billigere Stunde (Min: {{ min_price | round(1) }}ct)
            {% endif %}
          {% else %}
            Keine Preisdaten verfügbar
          {% endif %}
        
        stunden_bis_billigste: >
          {% set data = state_attr('sensor.epex_spot_data_market_price', 'data') %}
          {% if data %}
            {% set now_ts = now() | as_timestamp %}
            {% set ns = namespace(cheapest_price=999, cheapest_ts=0) %}
            {% for item in data %}
              {% set start_ts = item.start_time | as_timestamp %}
              {% if start_ts > now_ts and item.price_per_kwh < ns.cheapest_price %}
                {% set ns.cheapest_price = item.price_per_kwh %}
                {% set ns.cheapest_ts = start_ts %}
              {% endif %}
            {% endfor %}
            {% if ns.cheapest_ts > 0 %}
              {{ ((ns.cheapest_ts - now_ts) / 3600) | round(1) }}
            {% else %}
              0
            {% endif %}
          {% else %}
            0
          {% endif %}
        
        top5_billigste: >
          {% set data = state_attr('sensor.epex_spot_data_market_price', 'data') %}
          {% if data %}
            {% set now_ts = now() | as_timestamp %}
            {% set ns = namespace(items=[]) %}
            {% for item in data %}
              {% if item.start_time | as_timestamp > now_ts %}
                {% set ns.items = ns.items + [{'time': item.start_time | as_timestamp | timestamp_custom('%H:%M', true), 'price': (item.price_per_kwh * 100) | round(2)}] %}
              {% endif %}
            {% endfor %}
            {% set sorted_items = ns.items | sort(attribute='price') %}
            {{ sorted_items[:5] }}
          {% else %}
            []
          {% endif %}
