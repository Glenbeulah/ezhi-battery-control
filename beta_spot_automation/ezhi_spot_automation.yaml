# ============================================================================
# EZHI Batterie-Regelung v1.1.1-beta - MIT SPOT-PREIS-STEUERUNG
# ============================================================================
# BETA VERSION - Zum Testen!
#
# WICHTIG: NUR FÜR DYNAMISCHE STROMTARIFE OHNE DIREKTVERMARKTUNG!
# (z.B. Tibber, aWATTar, Ostrom, 1Komma5°)
#
# WICHTIG: SENSOR-NAMEN ANPASSEN!
# Diese Sensoren müssen an deine Installation angepasst werden:
#
#   sensor.sm63_net_power       → Dein Smart Meter Netzleistung (W)
#   sensor.pv_produktion_gesamt → Deine gesamte PV-Produktion (W)
#   sensor.battery_soc          → Dein Batterie-SOC (%)
#   sensor.ezhi_battery_power   → Deine Batterie-Leistung (W)
#   number.ezhi_on_grid_power   → Dein EZHI On-Grid Setpoint
#
# BENÖTIGT:
# 1. Template Sensoren aus ezhi_spot_templates.yaml
# 2. SQL Sensor aus ezhi_spot_sql.yaml
# 3. EPEX Spot Integration: https://github.com/mampfes/ha_epex_spot
# 4. Solcast Integration: https://github.com/BJReplay/ha-solcast-solar
# 5. Basis-Helfer aus helpers.yaml
#
# CHANGELOG v1.1.1:
# - FIX: pv_laden greift nicht mehr aktiv ein (Bug: lud aus Netz statt PV!)
# - FIX: halten erhöht Limit nicht mehr (führte zu teurem Netzbezug)
# - KLARSTELLUNG: pv_laden und halten sind nur noch Anzeige-Status
# - Normale Regelung übernimmt bei pv_laden und halten
#
# CHANGELOG v1.1.0:
# - NEU: 5 Action-Zustände (pv_laden, netz_laden, entladen, halten, normal)
# - NEU: Timeout-Schutz mit stabilem Aufwach-Wert (-50W)
# - NEU: Totband (30W) verhindert Oszillationen
# - VERBESSERT: SOC-Schutz-Logik aus v1.0.4
#
# DIE 5 ZUSTÄNDE:
# - pv_laden:   Anzeige: PV-Überschuss lädt Batterie (normale Regelung aktiv)
# - netz_laden: AKTIV: Günstig → Laden aus Netz auf berechnetes Ziel
# - entladen:   Anzeige + tieferes Limit: Teuer → Eigenverbrauch aus Batterie
# - halten:     Anzeige: Batterie am Limit, wartet auf Laden (normale Regelung)
# - normal:     Standard-Nulleinspeisungs-Regelung
# ============================================================================

alias: EZHI Batterie-Regelung v1.1.1-beta (Spot)
description: >
  Intelligente Nulleinspeisung mit Spot-Preis-Optimierung.
  
  AKTIVE EINGRIFFE:
  - netz_laden: Günstige Stunde → Aktiv aus Netz laden bis Ziel-SOC
  - entladen: Teure Stunde → Tieferes Entlade-Limit erlaubt
  
  NUR ANZEIGE (normale Regelung läuft):
  - pv_laden: PV-Überschuss wird geladen
  - halten: Batterie am Limit, wartet auf Lade-Gelegenheit
  - normal: Keine Spot-Optimierung aktiv

triggers:
  - entity_id:
      - sensor.sm63_net_power
    trigger: state

conditions:
  - condition: template
    value_template: >
      {% set last = this.attributes.last_triggered | default(0, true) %}
      {{ (as_timestamp(now()) - (as_timestamp(last) | float(0))) > 0.3 }}
  # Nicht im Manuell-Modus
  - condition: template
    value_template: "{{ states('input_select.ezhi_modus') != 'Manuell' }}"

actions:
  - variables:
      # === SENSOR-WERTE ===
      istwert: "{{ states('sensor.sm63_net_power') | float(0) }}"
      aktuell: "{{ states('number.ezhi_on_grid_power') | float(0) }}"
      soc: "{{ states('sensor.battery_soc') | float(0) }}"
      pv_power: "{{ states('sensor.pv_produktion_gesamt') | float(0) }}"
      wr_istwert: "{{ states('sensor.ezhi_battery_power') | float(0) }}"
      wr_im_timeout: "{{ (aktuell | abs) > 50 and (wr_istwert | abs) < 10 }}"
      
      # === MODUS & SPOT ===
      modus: "{{ states('input_select.ezhi_modus') }}"
      spot_action: "{{ states('sensor.ezhi_spot_action') }}"
      spot_grund: "{{ states('sensor.ezhi_spot_grund') }}"
      spot_preis: "{{ (states('sensor.epex_spot_data_market_price') | float(0) * 100) | round(1) }}"
      spot_quantile: "{{ states('sensor.epex_spot_data_quantile') | float(0.5) }}"
      
      # === DYNAMISCHE LIMITS (aus Template Sensoren) ===
      # Nur bei entladen wird das Limit gesenkt, sonst Basis-Limit
      entlade_limit: >
        {% if modus == 'Spot-Optimiert' and spot_action == 'entladen' %}
          {{ states('sensor.ezhi_dynamisches_entlade_limit') | float(20) }}
        {% else %}
          {{ states('input_number.entlade_limit') | float(20) }}
        {% endif %}
      netzladen_max_soc: "{{ states('sensor.ezhi_spot_netzladen_max_soc') | float(60) }}"
      ladeziel_soc: "{{ state_attr('sensor.ezhi_spot_action', 'ladeziel_soc') | int(80) }}"
      
      # === BASIS-HELFER ===
      lade_limit: "{{ states('input_number.lade_limit') | float(95) }}"
      puffer: "{{ states('input_number.puffer_leistung') | float(100) }}"
      
      # === KONSTANTEN ===
      sollwert: -10
      min_inverter: -1200
      max_inverter: 1200
      
      # === SOC-SCHUTZ PARAMETER (v1.0.4) ===
      soc_schutz_puffer: 70
      soc_schutz_rampe: 40
      soc_schutz_min_ladung: 30
      soc_schutz_totband: 30
      soc_schutz_aufwach_wert: -50
      
      # === PEAK-ERKENNUNG (wie v1.0.0) ===
      peak_schwelle_niedrig: "{{ states('input_number.peak_schwelle_niedrig') | float(200) }}"
      peak_schwelle_hoch: "{{ states('input_number.peak_schwelle_hoch') | float(600) }}"
      peak_level: |
        {% if istwert > peak_schwelle_hoch %}
          2
        {% elif istwert > peak_schwelle_niedrig %}
          1
        {% else %}
          0
        {% endif %}
      
      last_peak: "{{ states('input_datetime.last_peak') | as_timestamp | default(0) | float(0) }}"
      time_since_peak: "{{ as_timestamp(now()) - last_peak }}"
      
      post_peak_damping: |
        {% set t = time_since_peak %}
        {% if t < 15 %}
          0.4
        {% elif t < 45 %}
          0.7
        {% elif t < 90 %}
          0.9
        {% else %}
          1.0
        {% endif %}
      
      faktor_basis: 0.25
      faktor_peak_klein: 0.6
      faktor_peak_gross: 1
      
      faktor: >
        {% set level = peak_level | int %}
        {% set base = faktor_peak_gross if level == 2 else (faktor_peak_klein if level == 1 else faktor_basis) %}
        {{ (base * post_peak_damping) | float }}
      
      tau: 45
      decay: |
        {% set t = time_since_peak %}
        {% if t > 120 %}
          1.0
        {% else %}
          {{ (2.718281828459045 ** (-t/tau)) | float }}
        {% endif %}
      
      delta: |
        {% set raw = (istwert | float) * (faktor | float) %}
        {% set max_delta = 600 %}
        {% if raw > max_delta %}
          {{ max_delta }}
        {% elif raw < -max_delta %}
          {{ -max_delta }}
        {% else %}
          {{ raw | round(0) }}
        {% endif %}
      
      new_value: |
        {% set target = (aktuell | float) + ((delta | float) * (decay | float)) %}
        {% if target > max_inverter %}
          {{ max_inverter }}
        {% elif target < min_inverter %}
          {{ min_inverter }}
        {% else %}
          {{ target | round(0) }}
        {% endif %}
      
      # === SOC-SCHUTZ LADEWERT (v1.0.4 mit Timeout + Totband) ===
      soc_schutz_ladewert: |
        {# === TIMEOUT-SCHUTZ === #}
        {% if wr_im_timeout %}
          {{ soc_schutz_aufwach_wert }}
        {% elif pv_power > 10 and istwert < -30 %}
          {# === PV-LADEN MÖGLICH === #}
          {% set ueberschuss = istwert | float %}
          {% set ziel = ueberschuss - wr_istwert + soc_schutz_puffer %}
          
          {% if ziel < min_inverter %}
            {% set ziel = min_inverter %}
          {% endif %}
          {% if ziel > -soc_schutz_min_ladung %}
            {% set ziel = -soc_schutz_min_ladung %}
          {% endif %}
          
          {# === TOTBAND: Nur ändern wenn Differenz > 30W === #}
          {% set differenz = (aktuell - ziel) | abs %}
          {% if differenz < soc_schutz_totband %}
            {{ aktuell | round(0) }}
          {% elif aktuell > ziel %}
            {% set neuer_wert = aktuell - soc_schutz_rampe %}
            {% if neuer_wert < ziel %}
              {% set neuer_wert = ziel %}
            {% endif %}
            {{ neuer_wert | round(0) }}
          {% else %}
            {{ ziel | round(0) }}
          {% endif %}
        {% else %}
          0
        {% endif %}
  
  - choose:
      # =================================================================
      # SPOT-MODUS: NETZ-LADEN (günstige Stunde) - AKTIVER EINGRIFF
      # =================================================================
      - conditions:
          - condition: template
            value_template: "{{ modus == 'Spot-Optimiert' and spot_action == 'netz_laden' }}"
          - condition: template
            value_template: "{{ soc < ladeziel_soc }}"
        sequence:
          - action: system_log.write
            data:
              message: >-
                [SPOT-NETZ] {{ spot_grund }} | SOC: {{ soc }}% → {{ ladeziel_soc }}%
              level: info
          - action: number.set_value
            target:
              entity_id: number.ezhi_on_grid_power
            data:
              value: "{{ min_inverter }}"
          - stop: ""
      
      # =================================================================
      # SPOT-MODUS: NETZ-LADEN aber Ziel erreicht → normale Regelung
      # =================================================================
      - conditions:
          - condition: template
            value_template: "{{ modus == 'Spot-Optimiert' and spot_action == 'netz_laden' }}"
          - condition: template
            value_template: "{{ soc >= ladeziel_soc }}"
        sequence:
          - action: system_log.write
            data:
              message: >-
                [SPOT] Laden empfohlen, aber SOC {{ soc }}% >= Ziel {{ ladeziel_soc }}% → normale Regelung
              level: info
          # Weiter mit normaler Regelung (kein stop!)
      
      # =================================================================
      # SPOT-MODUS: ENTLADEN (teure Stunde) - NUR LOGGING
      # Tieferes Limit ist bereits in Variable entlade_limit gesetzt
      # =================================================================
      - conditions:
          - condition: template
            value_template: "{{ modus == 'Spot-Optimiert' and spot_action == 'entladen' }}"
          - condition: template
            value_template: "{{ soc > entlade_limit }}"
        sequence:
          - action: system_log.write
            data:
              message: >-
                [SPOT-ENTLADEN] {{ spot_grund }} | Limit: {{ entlade_limit }}% (dynamisch tiefer)
              level: info
          # Weiter mit normaler Regelung (tieferes Limit aktiv, kein stop!)
      
      # =================================================================
      # SOC-SCHUTZ (mit dynamischem Limit)
      # Greift bei pv_laden, halten, normal wenn SOC am Limit
      # =================================================================
      - conditions:
          - condition: template
            value_template: "{{ soc <= entlade_limit }}"
        sequence:
          - action: system_log.write
            data:
              message: >-
                [SOC-SCHUTZ] {{ soc }}% ≤ {{ entlade_limit }}%
                {% if wr_im_timeout %}[TIMEOUT]{% endif %}
                {% if modus == 'Spot-Optimiert' %} (Spot: {{ spot_action }}){% endif %}
              level: info
          - action: number.set_value
            target:
              entity_id: number.ezhi_on_grid_power
            data:
              value: "{{ soc_schutz_ladewert }}"
          - stop: ""
    
    # =================================================================
    # NORMALE REGELUNG
    # Läuft bei: pv_laden, halten, normal, entladen (mit tieferem Limit)
    # =================================================================
    default:
      - condition: template
        value_template: "{{ (istwert > (sollwert + puffer) or istwert < (sollwert - puffer)) }}"
      
      - action: number.set_value
        target:
          entity_id: number.ezhi_on_grid_power
        data:
          value: "{{ new_value }}"
      
      - action: system_log.write
        data:
          message: >-
            [REGELUNG] {{ modus }}
            {% if modus == 'Spot-Optimiert' %}| Spot: {{ spot_action }} ({{ spot_preis }}ct, Q{{ (spot_quantile*100)|round(0) }}%){% endif %}
            | ist={{ istwert }}W → neu={{ new_value }}W
          level: info
      
      - if:
          - condition: template
            value_template: "{{ peak_level > 0 and (last_peak == 0 or time_since_peak > 30) }}"
        then:
          - action: input_datetime.set_datetime
            target:
              entity_id: input_datetime.last_peak
            data:
              timestamp: "{{ as_timestamp(now()) }}"

mode: single
max_exceeded: silent
