# ============================================================================
# EZHI Spot-Steuerung v1.1.0-beta - SQL Sensor für Verbrauchsprofil
# ============================================================================
# Einbinden in configuration.yaml:
#
#   sql: !include ezhi_spot_sql.yaml
#
# ODER den Inhalt direkt unter sql: einfügen.
#
# WICHTIG: statistic_id muss zu deinem Sensor passen!
# ============================================================================

- name: "EZHI Verbrauchsprofil 7 Tage"
  db_url: sqlite:////config/home-assistant_v2.db
  query: >
    SELECT json_group_object(hour, ROUND(avg_diff, 0)) as hourly_json
    FROM (
      SELECT 
        strftime('%H', start_ts, 'unixepoch', 'localtime') as hour,
        AVG(state - prev_state) as avg_diff
      FROM (
        SELECT 
          start_ts,
          state,
          LAG(state) OVER (ORDER BY start_ts) as prev_state
        FROM statistics
        WHERE metadata_id = (
          SELECT id FROM statistics_meta 
          WHERE statistic_id = 'sensor.smart_meter_ac_meter_total_watt_hours_imported'
        )
        AND start_ts > strftime('%s', 'now', '-7 days')
      )
      WHERE prev_state IS NOT NULL 
        AND (state - prev_state) >= 0 
        AND (state - prev_state) < 5000
      GROUP BY hour
    )
  column: "hourly_json"

# ============================================================================
# ERGEBNIS:
# ============================================================================
# Der Sensor liefert ein JSON-Objekt im Attribut "hourly_json":
#
# {"00":63,"01":58,"02":59,"07":179,"08":132,"17":259,...}
#
# Werte = Durchschnittlicher Verbrauch in Wh pro Stunde (letzte 7 Tage)
#
# HINWEIS: Das JSON ist zu lang für den State (max 255 Zeichen),
# daher steht es nur im Attribut. Das ist korrekt so!
# ============================================================================
