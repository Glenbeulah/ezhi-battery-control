# ============================================================================
# EZHI Spot-Steuerung v1.1.0-beta - SQL Sensor f체r Verbrauchsprofil
# ============================================================================
# Einbinden in configuration.yaml:
#
#   sql: !include ezhi_spot_sql.yaml
#
# WICHTIG: statistic_id anpassen! Siehe Optionen unten.
# ============================================================================

- name: "EZHI Verbrauchsprofil 7 Tage"
  db_url: sqlite:////config/home-assistant_v2.db
  query: >
    SELECT json_group_object(hour, ROUND(avg_diff, 0)) as hourly_json
    FROM (
      SELECT 
        strftime('%H', start_ts, 'unixepoch', 'localtime') as hour,
        AVG(state - prev_state) as avg_diff
      FROM (
        SELECT 
          start_ts,
          state,
          LAG(state) OVER (ORDER BY start_ts) as prev_state
        FROM statistics
        WHERE metadata_id = (
          SELECT id FROM statistics_meta 
          WHERE statistic_id = 'sensor.hausverbrauch_total'
        )
        AND start_ts > strftime('%s', 'now', '-7 days')
      )
      WHERE prev_state IS NOT NULL 
        AND (state - prev_state) >= 0 
        AND (state - prev_state) < 5000
      GROUP BY hour
    )
  column: "hourly_json"

# ============================================================================
# WELCHEN SENSOR VERWENDEN?
# ============================================================================
#
# OPTION A: Echter Hausverbrauch (EMPFOHLEN)
# ------------------------------------------
# Verwende sensor.hausverbrauch_total aus ezhi_hausverbrauch_template.yaml
# 
# Vorteile:
#   - Zeigt echten Verbrauch inkl. PV-Eigenverbrauch
#   - Profil ist unabh채ngig von Sonnenschein
#   - Genauere Prognosen
#
# statistic_id = 'sensor.hausverbrauch_total'
#
#
# OPTION B: Nur Netzbezug (EINFACHER)
# -----------------------------------
# Verwende direkt deinen Smart Meter Import-Sensor
#
# Nachteile:
#   - Zeigt nur Netzbezug, nicht echten Verbrauch
#   - Tags체ber zu niedrige Werte (PV-Eigenverbrauch fehlt)
#   - Sommer vs. Winter unterschiedlich
#
# statistic_id = 'sensor.DEIN_SMARTMETER_IMPORT_WH'
#
# ============================================================================

# ============================================================================
# ERGEBNIS
# ============================================================================
# Der Sensor liefert ein JSON-Objekt im Attribut "hourly_json":
#
# {"00":63,"01":58,"02":59,"07":179,"08":132,"17":259,...}
#
# Werte = Durchschnittlicher Verbrauch in Wh pro Stunde (letzte 7 Tage)
#
# HINWEIS: Das JSON ist zu lang f체r den State (max 255 Zeichen),
# daher steht es nur im Attribut. Das ist korrekt so!
# ============================================================================
