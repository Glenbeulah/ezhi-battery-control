# ============================================================================
# EZHI Spot-Steuerung v1.2.0-beta - Dashboard
# ============================================================================
# Installation:
# 1. Einstellungen â†’ Dashboards â†’ Dashboard hinzufÃ¼gen â†’ "EZHI Spot"
# 2. Dashboard Ã¶ffnen â†’ Bearbeiten â†’ Raw-Konfigurationseditor
# 3. Diesen Inhalt einfÃ¼gen
#
# BenÃ¶tigt (optional, aber empfohlen):
# - apexcharts-card (HACS) fÃ¼r Preis- und Verbrauchsgrafiken
# - mushroom-cards (HACS) fÃ¼r schÃ¶nere Status-Karten
# - mini-graph-card (HACS) fÃ¼r kompakte Grafiken
# ============================================================================

title: EZHI Spot-Steuerung
views:
  - title: Ãœbersicht
    path: uebersicht
    icon: mdi:battery-charging
    cards:
      # ================================================================
      # HEADER
      # ================================================================
      - type: markdown
        content: |
          # ðŸ”‹ EZHI Spot-Steuerung
          **Beta v1.2.0** - Vorausschauende Batterie-Optimierung

      # ================================================================
      # STATUS + MODUS (mit Mushroom Cards)
      # ================================================================
      - type: horizontal-stack
        cards:
          - type: custom:mushroom-template-card
            primary: "{{ states('sensor.ezhi_spot_action') | upper }}"
            secondary: "{{ states('sensor.ezhi_spot_grund') }}"
            icon: >
              {% set action = states('sensor.ezhi_spot_action') %}
              {% if action == 'pv_laden' %}mdi:solar-power
              {% elif action == 'netz_laden' %}mdi:battery-charging-high
              {% elif action == 'entladen' %}mdi:battery-arrow-down-outline
              {% elif action == 'halten' %}mdi:battery-lock
              {% else %}mdi:battery-50{% endif %}
            icon_color: >
              {% set action = states('sensor.ezhi_spot_action') %}
              {% if action == 'pv_laden' %}light-green
              {% elif action == 'netz_laden' %}green
              {% elif action == 'entladen' %}red
              {% elif action == 'halten' %}amber
              {% else %}blue{% endif %}
            layout: vertical
            tap_action:
              action: more-info
              entity: sensor.ezhi_spot_empfehlung

          - type: custom:mushroom-select-card
            entity: input_select.ezhi_modus
            name: Betriebsmodus
            icon: mdi:auto-fix

      # ================================================================
      # STATUS (Fallback ohne Mushroom Cards)
      # ================================================================
      - type: conditional
        conditions:
          - condition: state
            entity: sensor.ezhi_spot_action
            state_not: unavailable
        card:
          type: entities
          title: Status (Fallback)
          show_header_toggle: false
          entities:
            - entity: sensor.ezhi_spot_action
              name: Empfehlung
            - entity: sensor.ezhi_spot_grund
              name: BegrÃ¼ndung
            - entity: input_select.ezhi_modus
              name: Modus

      # ================================================================
      # 48h STROMPREIS-CHART (NEU!)
      # ================================================================
      - type: custom:apexcharts-card
        header:
          show: true
          title: âš¡ Strompreis 48h Vorschau
          show_states: true
          colorize_states: true
        graph_span: 48h
        span:
          start: day
        now:
          show: true
          label: Jetzt
          color: white
        yaxis:
          - id: preis
            decimals: 2
            apex_config:
              tickAmount: 5
              title:
                text: ct/kWh
        series:
          - entity: sensor.epex_spot_data_market_price
            name: Strompreis
            yaxis_id: preis
            type: column
            float_precision: 2
            extend_to: end
            data_generator: |
              return entity.attributes.data.map((entry) => {
                return [new Date(entry.start_time).getTime(), entry.price_per_kwh * 100];
              });
            color_threshold:
              - value: 0
                color: "#186ddc"
              - value: 5
                color: "#04822e"
              - value: 6
                color: "#12A141"
              - value: 7
                color: "#79B92C"
              - value: 8
                color: "#C4D81D"
              - value: 9
                color: "#F3DC0C"
              - value: 10
                color: "#FFA500"
              - value: 12
                color: "#FF6347"
              - value: 15
                color: "#FF0000"
        experimental:
          color_threshold: true
        apex_config:
          chart:
            height: 250
          tooltip:
            x:
              format: "dd.MM HH:mm"
          legend:
            show: false

      # ================================================================
      # SPOT-PREISE KOMPAKT
      # ================================================================
      - type: vertical-stack
        cards:
          - type: markdown
            content: "## ðŸ’° Strompreis"

          - type: horizontal-stack
            cards:
              - type: entity
                entity: sensor.epex_spot_data_market_price
                name: Aktuell
                unit: ct/kWh
                icon: mdi:currency-eur

              - type: entity
                entity: sensor.epex_spot_data_rank
                name: Rang
                icon: mdi:podium

              - type: entity
                entity: sensor.epex_spot_data_quantile
                name: Quantil
                icon: mdi:percent

          - type: gauge
            entity: sensor.epex_spot_data_market_price
            name: Strompreis
            unit: ct/kWh
            min: 0
            max: 15
            needle: true
            segments:
              - from: 0
                color: "#04822e"
              - from: 5
                color: "#79B92C"
              - from: 7
                color: "#C4D81D"
              - from: 9
                color: "#FFA500"
              - from: 12
                color: "#FF0000"

      # ================================================================
      # ENERGIE-BILANZ (nÃ¤chste 4 Stunden)
      # ================================================================
      - type: vertical-stack
        cards:
          - type: markdown
            content: "## âš¡ Energie-Bilanz (nÃ¤chste 4h)"

          - type: horizontal-stack
            cards:
              - type: entity
                entity: sensor.ezhi_erwarteter_verbrauch_stunde
                name: Verbrauch/h
                icon: mdi:home-lightning-bolt

              - type: entity
                entity: sensor.ezhi_energie_bilanz_4h
                name: Bilanz 4h
                icon: mdi:scale-balance

              - type: entity
                entity: sensor.ezhi_pv_prognose_4h
                name: PV 4h
                icon: mdi:solar-power

          - type: entities
            entities:
              - type: attribute
                entity: sensor.ezhi_erwarteter_verbrauch_stunde
                attribute: naechste_stunde
                name: Verbrauch nÃ¤chste Stunde
                suffix: " Wh"
              - type: attribute
                entity: sensor.ezhi_erwarteter_verbrauch_stunde
                attribute: naechste_4_stunden
                name: Verbrauch nÃ¤chste 4h
                suffix: " Wh"
              - type: attribute
                entity: sensor.ezhi_energie_bilanz_4h
                attribute: bewertung
                name: Bewertung

      # ================================================================
      # BATTERIE-STATUS
      # ================================================================
      - type: vertical-stack
        cards:
          - type: markdown
            content: "## ðŸ”‹ Batterie"

          - type: horizontal-stack
            cards:
              - type: gauge
                entity: sensor.ezhi_800_battery_soc
                name: SOC
                min: 0
                max: 100
                severity:
                  red: 0
                  yellow: 20
                  green: 50
                needle: true

              - type: entity
                entity: sensor.ezhi_800_battery_power
                name: Leistung
                icon: mdi:lightning-bolt

          - type: entities
            title: Dynamische Limits
            entities:
              - entity: sensor.ezhi_dynamisches_entlade_limit
                name: Entlade-Limit (dynamisch)
              - entity: input_number.entlade_limit
                name: Entlade-Limit (Basis)
              - entity: sensor.ezhi_spot_netzladen_max_soc
                name: Max SOC Netzladen

      # ================================================================
      # SPOT SCORE GAUGE
      # ================================================================
      - type: gauge
        entity: sensor.ezhi_spot_score
        name: Spot Score
        min: -100
        max: 100
        severity:
          red: -100
          yellow: -30
          green: 30
        needle: true

      # ================================================================
      # VERBRAUCHSPROFIL (ApexCharts)
      # ================================================================
      - type: markdown
        content: |
          ## ðŸ“Š Verbrauchsprofil
          *Durchschnitt der letzten 7 Tage pro Stunde*

      - type: custom:apexcharts-card
        header:
          show: true
          title: Verbrauchsprofil (Ã˜ 7 Tage)
          show_states: false
        graph_span: 24h
        span:
          start: day
        apex_config:
          chart:
            height: 200px
          xaxis:
            labels:
              format: HH
          plotOptions:
            bar:
              distributed: true
          legend:
            show: false
        series:
          - entity: sensor.ezhi_verbrauchsprofil_7_tage
            name: Verbrauch
            type: column
            data_generator: |
              const data = entity.attributes.hourly_json;
              if (!data) return [];
              let json = data;
              if (typeof data === 'string') {
                try { json = JSON.parse(data); } catch(e) { return []; }
              }
              const values = Object.values(json).map(v => parseFloat(v));
              const sorted = [...values].sort((a, b) => a - b);
              const low = sorted[Math.floor(sorted.length * 0.3)];
              const high = sorted[Math.floor(sorted.length * 0.7)];
              const now = new Date();
              const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
              return Object.entries(json).map(([hour, value]) => {
                const time = new Date(today.getTime() + parseInt(hour) * 3600000);
                let color = '#ffc107';
                if (value <= low) color = '#4caf50';
                if (value >= high) color = '#f44336';
                return { x: time.getTime(), y: value, fillColor: color };
              }).sort((a, b) => a.x - b.x);

      # ================================================================
      # HISTORY GRAPH
      # ================================================================
      - type: history-graph
        title: Verlauf (24h)
        hours_to_show: 24
        entities:
          - entity: sensor.ezhi_spot_action
            name: Aktion
          - entity: sensor.epex_spot_data_rank
            name: Preis-Rang
          - entity: sensor.ezhi_800_battery_soc
            name: SOC

      # ================================================================
      # DEBUG / ALLE SENSOREN
      # ================================================================
      - type: entities
        title: ðŸ”§ Debug / Alle Sensoren
        show_header_toggle: false
        entities:
          - type: section
            label: Spot-Sensoren
          - entity: sensor.ezhi_spot_action
          - entity: sensor.ezhi_spot_grund
          - entity: sensor.ezhi_spot_score
          - entity: sensor.ezhi_spot_empfehlung
          - type: section
            label: Dynamische Werte
          - entity: sensor.ezhi_dynamisches_entlade_limit
          - entity: sensor.ezhi_spot_netzladen_max_soc
          - type: section
            label: Verbrauch & PV
          - entity: sensor.ezhi_verbrauchsprofil_7_tage
          - entity: sensor.ezhi_erwarteter_verbrauch_stunde
          - entity: sensor.ezhi_pv_prognose_4h
          - entity: sensor.ezhi_energie_bilanz_4h
          - type: section
            label: Externe Daten
          - entity: sensor.epex_spot_data_market_price
          - entity: sensor.epex_spot_data_rank
          - entity: sensor.epex_spot_data_quantile
          - entity: sensor.solcast_pv_forecast_prognose_verbleibende_leistung_heute
          - entity: sensor.solcast_pv_forecast_prognose_morgen
